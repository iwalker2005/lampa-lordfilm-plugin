# Техническое задание (доработанное)
## Плагин-балансер «LordFilm» для Lampa

**Документ:** ТЗ v1.1  
**Дата:** 26 февраля 2026  
**Основа:** ТЗ v1.0 + приложение с детализацией прокси  
**Заказчик:** Олег Ивонин

---

## 1. Цель и результат

Разработать плагин-источник для Lampa, который:
- принимает данные карточки фильма/сериала из Lampa;
- находит соответствующий контент на LordFilm;
- предоставляет валидный поток для встроенного плеера Lampa;
- поддерживает выбор озвучки/качества, сезонов/серий;
- сохраняет избранное и прогресс просмотра;
- работает через серверный прокси для обхода CORS.

Результат поставки: готовый `lordfilm.js` + исходники + README + (при необходимости) Cloudflare Worker прокси.
Формат плагина для подключения в Lampa: один JavaScript-файл `lordfilm.js` по прямой публичной URL-ссылке.

---

## 2. Границы реализации (MVP)

### 2.1. Входит в MVP (обязательно)
- Поиск по названию и году.
- Фильм: выбор озвучки и качества, запуск потока.
- Сериал: выбор сезона/серии/озвучки, запуск потока.
- Запоминание позиции и предложение «продолжить».
- Локальное избранное.
- Прокси для HTML/API запросов.
- Совместимость с Android и Android TV (D-pad навигация).
- TV-first интерфейс: все ключевые действия выполняются с пульта без тач-ввода.

### 2.2. Вне MVP (можно после v1.0)
- Browse-каталог внутри самого плагина.
- Фильтры по году/жанру/стране в отдельном каталоге.
- Расширенная аналитика и телеметрия.
- Мульти-прокси и автопереключение между провайдерами.

---

## 3. Архитектура решения

## 3.1. Компоненты
- **Клиентская часть (Lampa plugin):** `lordfilm.js`
- **Прокси-слой (server-side):** Cloudflare Worker (рекомендуется)
- **Источник контента:** LordFilm (домен настраиваемый)

## 3.2. Поток данных
1. Пользователь открывает карточку в Lampa и выбирает источник `LordFilm`.
2. Плагин формирует поисковый запрос и отправляет его в прокси.
3. Прокси делает запрос к LordFilm и возвращает ответ (HTML/JSON).
4. Плагин парсит результаты, выбирает лучший матч.
5. Плагин получает данные плеера/потоков.
6. Плагин запускает `Lampa.Player` с выбранным потоком.

## 3.3. Структура репозитория
```text
lordfilm-plugin/
├── lordfilm.js
├── README.md
├── docs/
│   └── ТЗ_LordFilm_Lampa_v1.1.md
└── proxy/
    ├── worker.js
    └── README.md
```

## 3.4. Референсный репозиторий (обязательно)
- Базовый технический референс: `https://github.com/nb557/plugins`
- Использовать как ориентир для:
  - паттернов интеграции с Lampa API;
  - структуры JS-плагина;
  - подходов к прокси/CORS.
- Прямая копия кода без адаптации запрещена.
- При заимствовании фрагментов сохранять атрибуцию и соблюдать лицензионные условия источника.

---

## 4. Прокси: развёртывание и API-контракт

## 4.1. Зачем прокси
- В Lampa (WebView) прямые запросы на сторонний домен блокируются CORS.
- На источнике может быть anti-bot логика, которую нельзя стабильно обрабатывать на клиенте.
- Прокси централизует заголовки, ограничения и контроль доступа.

## 4.2. Рекомендуемая платформа
- **Cloudflare Workers** (приоритетный вариант для MVP).
- Альтернатива: Node.js на VPS.

## 4.3. Базовые требования к прокси
- Обязательный токен в заголовке: `X-Proxy-Token`.
- Белый список целевых хостов (минимум текущий домен LordFilm + служебные домены плеера).
- CORS-ответы для Lampa (`Access-Control-Allow-Origin: *`).
- Таймаут на upstream запросы: 10–15 сек.
- Логирование ошибок без сохранения персональных данных.

## 4.4. Endpoint: `/health`
`GET /health`

Ответ:
```json
{
  "ok": true,
  "version": "1.0.0",
  "time": "2026-02-26T12:00:00Z"
}
```

## 4.5. Endpoint: `/proxy`
`GET /proxy?url=<encoded_target_url>`

### Запрос
- Header: `X-Proxy-Token: <secret>`
- Query: `url` — полный URL к целевой странице/API

### Поведение
- Проверить токен.
- Проверить, что `url` принадлежит разрешённому домену.
- Подставить `User-Agent`, `Referer`, `Origin` (по необходимости).
- Вернуть либо raw-ответ upstream, либо JSON-обёртку.

### Вариант ответа (JSON-обёртка)
```json
{
  "status": 200,
  "content_type": "text/html; charset=utf-8",
  "body": "<html>...</html>"
}
```

### Ошибка
```json
{
  "status": 403,
  "error": "Forbidden"
}
```

## 4.6. Endpoint: `/stream` (опционально, но рекомендуется)
`GET /stream?url=<encoded_video_url>`

Нужен для случаев, когда m3u8/mp4 требует корректные `Referer/Origin` или range-запросы.

Требования:
- Проксирование `Range`/`Content-Range`/`Accept-Ranges`.
- Без изменения бинарного потока.
- Ограничение только на разрешённые video-домены.

---

## 5. Интеграция с Lampa

## 5.1. Регистрация плагина
- Использовать `Lampa.Component.add('lordfilm', component)`
- Добавить источник в контекст карточки фильма/сериала.

## 5.2. Используемые API Lampa
- `Lampa.Component` — регистрация компонента.
- `Lampa.Activity` — переходы между экранами выбора.
- `Lampa.Player` — запуск потока / плейлиста.
- `Lampa.Storage` — избранное, прогресс, кэш матчей.

Документация и референсы по Lampa API:
- Репозиторий исходников Lampa: `https://github.com/yumata/lampa-source`
- Техническая wiki-документация: `https://deepwiki.com/yumata/lampa-source`
- Локальная документация из репозитория: выполнить `npm run doc`, затем открыть `build/doc/index.html`

## 5.3. Входные данные карточки
- `title`
- `original_title` (если есть)
- `year`
- `imdb_id` (если есть)
- `kinopoisk_id` (если есть)
- `type` (`movie`/`tv`)

## 5.4. TV-first интерфейс (обязательный режим)
- Навигация только с пульта: `Up/Down/Left/Right`, `OK`, `Back`, `Play/Pause`.
- На каждом экране всегда есть видимый фокусированный элемент.
- Фокус не должен “теряться” при подгрузке данных и после закрытия модальных окон.
- При возврате назад фокус возвращается на последний выбранный элемент списка.
- Порядок фокуса предсказуемый: слева-направо, сверху-вниз.
- На Android TV все сценарии плагина должны проходиться без мыши и без экранной клавиатуры.

---

## 6. Логика поиска и матчинга

## 6.1. Нормализация
- привести к нижнему регистру;
- убрать лишние символы и двойные пробелы;
- учитывать альтернативные названия (`title`, `original_title`).

## 6.2. Кандидаты
- Выполнить поиск по `title`.
- Если пусто: повторить по `original_title`.

## 6.3. Ранжирование
Скоринг кандидата:
- +60 за совпадение названия (fuzzy);
- +30 за совпадение года (±1 год допустимо);
- +10 за совпадение `imdb_id`/`kinopoisk_id` (если найдено).

Порог принятия матча в MVP: `>= 70`.

## 6.4. Ничего не найдено
Показать пользователю: `Контент не найден на LordFilm`.

---

## 7. Функциональные требования (уточнённые)

### 7.1. Поиск
- FR-01: Поиск по названию из карточки — обязательно.
- FR-02: Учет года в матчинге — обязательно.
- FR-03: ID-поиск (IMDB/KP), если доступно — желательно.
- FR-04: Явная ошибка «не найдено» — обязательно.

### 7.2. Фильмы
- FR-05: Получение прямого потока (`m3u8`/`mp4`) — обязательно.
- FR-06: Выбор озвучки — обязательно.
- FR-07: Выбор качества — обязательно.

### 7.3. Сериалы
- FR-08: Список сезонов — обязательно.
- FR-09: Список серий — обязательно.
- FR-10: Выбор озвучки — обязательно.
- FR-11: Поток выбранной серии — обязательно.
- FR-12: Автопереход на следующую серию — обязательно.

### 7.4. Избранное/прогресс
- FR-13..FR-15: Избранное + локальное сохранение — обязательно.
- FR-16..FR-18: Позиция просмотра и продолжение — обязательно.

### 7.5. Browse-фильтры
- FR-19..FR-22: после MVP.

### 7.6. TV интерфейс (обязательно)
- FR-23: Экран выбора озвучки должен быть адаптирован под D-pad (вертикальный список, видимый активный пункт).
- FR-24: Экран выбора сезона/серии должен открываться с фокусом на “последнем просмотренном” эпизоде (если есть прогресс).
- FR-25: В карточках серий должна быть явная индикация просмотренных серий и текущей серии.
- FR-26: Кнопка “Следующая серия” должна быть доступна с пульта за 1-2 нажатия от зоны управления плеером.
- FR-27: Все интерактивные элементы плагина должны иметь фокус-стили, контрастные на TV экране.

---

## 8. Нефункциональные требования (уточнённые)

- NR-01..NR-03: плагин не добавляет рекламу, не содержит рекламных вставок.
- NR-04: совместимость с актуальной версией Lampa.
- NR-05: Android 7.0+.
- NR-06: Android TV боксы.
- NR-07: полная D-pad навигация.
- NR-08: целевой отклик поиска: до 5 сек (при нормальном интернете).
- NR-09: отсутствие зависаний/крэшей.
- NR-10: CORS через прокси — обязательно.
- NR-11: устойчивость к ограничениями источника — обязательно.
- NR-12: Минимальный размер интерактивной зоны на TV: не менее 48px по высоте.
- NR-13: Текст основных элементов управления на TV должен быть читаем с расстояния 2-3 м.
- NR-14: Любой ключевой пользовательский путь (поиск → выбор → старт) выполняется только пультом.

---

## 9. Хранилище данных

Ключи `Lampa.Storage`:
- `lordfilm_favorites` — массив избранных карточек.
- `lordfilm_progress` — объект прогресса.
- `lordfilm_last_choice` — последняя озвучка/качество по тайтлу.
- `lordfilm_base_url` — базовый домен источника (для быстрой смены).
- `lordfilm_proxy_url` — URL прокси.
- `lordfilm_proxy_token` — токен прокси.

Формат прогресса:
```json
{
  "tmdb_12345": {
    "type": "tv",
    "season": 2,
    "episode": 5,
    "time": 834,
    "duration": 2710,
    "updated_at": 1760000000
  }
}
```

---

## 10. Ошибки и обработка

Матрица поведения:
- `401/403` от прокси: показать `Ошибка доступа к прокси`.
- `404` на источнике: `Контент недоступен`.
- `429` от источника: `Слишком много запросов, попробуйте позже`.
- таймаут: 1 автоматический ретрай, затем сообщение пользователю.
- невалидный поток: предложить другой вариант озвучки/качества.

---

## 11. Тестирование и приёмка

## 11.1. Тестовые устройства
- Android-смартфон (7.0+)
- Android TV приставка (D-pad)
- Web-версия Lampa (браузерный стенд):
`http://lampa.mx/?title=%D0%93%D0%BB%D0%B0%D0%B2%D0%BD%D0%B0%D1%8F%20-%20TMDB&component=main&source=tmdb&page=1`

## 11.2. Минимальные тест-кейсы
1. Подключение плагина по URL, появление в источниках.
2. Фильм: поиск, выбор озвучки/качества, старт проигрывания.
3. Сериал: сезоны/серии/озвучка, старт эпизода.
4. Автопереход к следующей серии.
5. Сохранение и восстановление позиции.
6. Избранное сохраняется между сессиями.
7. Ошибка прокси/таймаут корректно отображаются.
8. Навигация D-pad без “залипаний” фокуса.
9. После `Back` фокус возвращается на ранее выбранный элемент списка.
10. На экранах выбора нет элементов, недоступных с пульта.
11. На 1080p и 4K интерфейс остается читаемым и не обрезается по краям экрана.
12. Базовый сценарий в web-версии Lampa проходит без ошибок:
подключение плагина по URL, вход в источник, запуск поиска, отображение результатов.

## 11.3. Критерии готовности релиза
- Все обязательные FR и NR закрыты.
- Нет критических ошибок на 2 целевых устройствах.
- Есть рабочий README по подключению и прокси.

---

## 12. Артефакты поставки

- `lordfilm.js` (готовый к подключению по URL)
- исходники в GitHub репозитории
- `README.md` (установка/настройка/известные ограничения)
- `proxy/worker.js` + инструкция деплоя
- краткий changelog релиза

---

## 13. Публикация и подключение в Lampa (пошагово)

Этот раздел обязателен для пользователя без опыта разработки.

## 13.1. Что именно загружается
- Основной файл плагина: `lordfilm.js`
- (Опционально) файлы прокси в отдельной папке/репозитории
- Для Lampa нужен именно URL на `lordfilm.js`

## 13.2. Вариант A: подключение через `raw.githubusercontent.com`
1. Создать публичный репозиторий на GitHub.
2. Загрузить файл `lordfilm.js` в корень репозитория.
3. Получить прямую ссылку формата:  
   `https://raw.githubusercontent.com/<user>/<repo>/<branch>/lordfilm.js`
4. В Lampa открыть: `Настройки → Расширения → Добавить плагин → URL`.
5. Вставить прямую ссылку и перезапустить Lampa.

## 13.3. Вариант B: подключение через GitHub Pages
1. В репозитории открыть `Settings → Pages`.
2. Включить публикацию `Deploy from branch` (`main` / `root`).
3. Использовать ссылку формата:  
   `https://<user>.github.io/<repo>/lordfilm.js`
4. Вставить её в Lampa в поле URL плагина.

## 13.4. Какие ссылки нельзя вставлять в Lampa
- Нельзя URL страницы репозитория:  
  `https://github.com/<user>/<repo>`
- Нельзя URL папки:  
  `https://github.com/<user>/<repo>/tree/main`
- Нельзя URL `blob`-страницы файла:  
  `https://github.com/<user>/<repo>/blob/main/lordfilm.js`

В Lampa должна быть только прямая ссылка на содержимое JS-файла.

## 13.5. Проверка ссылки перед вставкой в Lampa
- Ссылка открывается в браузере и показывает JS-код.
- Ответ сервера `200 OK`.
- В URL явно указан файл `lordfilm.js`.
- Файл доступен без авторизации (репозиторий публичный).

---

## 14. План внедрения

### Этап 1 (MVP)
- каркас плагина + регистрация в Lampa;
- `/proxy` endpoint + токен;
- поиск фильма/сериала;
- воспроизведение, базовый выбор качества/озвучки.

### Этап 2
- прогресс и избранное;
- стабильная сериал-логика (сезоны/серии/автопереход);
- базовый кэш.

### Этап 3
- `/stream` endpoint;
- оптимизация скорости и устойчивости;
- подготовка релизной документации.

---

## 15. Риски и митигация

- Смена домена/вёрстки источника: вынести URL и селекторы в конфиг.
- Ограничения по anti-bot: прокси + ограничение частоты + retry/backoff.
- Изменения Lampa API: версия совместимости и быстрый hotfix.
- Перегрузка прокси: rate limit, кеширование, отдельные ключи окружений.

---

## 16. Открытые вопросы (зафиксировать перед кодом)

1. Финальный домен источника по умолчанию.
2. Нужен ли `/stream` в MVP или после первого релиза.
3. Где хранится `X-Proxy-Token` для прод-конфигурации.
4. Нужна ли поддержка нескольких зеркал в UI.
5. Минимальный список обязательных озвучек/качеств для приёмки.
